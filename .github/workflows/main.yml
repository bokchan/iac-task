name: Build and Deploy Application
on:
  push:
     branches:
       - main
  workflow_dispatch:
    inputs:
      target_job:
        description: 'Which job to run'
        required: true
        default: 'build'

permissions:
  id-token: write # Required for OIDC authentication with AWS
  contents: read # Required to check out the repository

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_DEFAULT_REGION: ${{ vars.AWS_REGION }}

jobs:
  # Run QA checks before any deployment
  qa-checks:
    name: Quality Assurance
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [infra, webapp]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run QA for ${{ matrix.target }}
        uses: ./.github/actions/run-qa
        with:
          target_directory: ${{ matrix.target }}

  # Build and push image for development environment
  build-and-deploy:
    needs: qa-checks
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get-image-tag.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get image tag (Git SHA)
        id: get-image-tag
        run: echo "image_tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup AWS Environment
        uses: ./.github/actions/setup-environment
        with:
          role_arn: ${{ secrets.AWS_GITHUB_ACTION_ROLE_ARN_DEV }}
          session_name: GitHubActions-Build-${{ github.run_id }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Build and Push Image
        uses: ./.github/actions/build-push-image
        with:
          ecr_repository: ${{ vars.AWS_ECR_REPOSITORY_DEV }}
          image_tag: ${{ steps.get-image-tag.outputs.image_tag }}

  # Deploy to development environment
  deploy-dev:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup AWS Environment
        uses: ./.github/actions/setup-environment
        with:
          role_arn: ${{ secrets.AWS_GITHUB_ACTION_ROLE_ARN }}
          session_name: GitHubActions-DevDeploy-${{ github.run_id }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Deploy CDK Infrastructure
        uses: ./.github/actions/deploy-cdk
        with:
          environment: dev
          image_tag: ${{ needs.build-and-deploy.outputs.image_tag }}

  # Build image for production and deploy to production environment
  deploy-prod:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      # Production deployment with unified role
      # Security: Manual approval configured in GitHub repository settings for 'production' environment
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup AWS Environment
        uses: ./.github/actions/setup-environment
        with:
          role_arn: ${{ secrets.AWS_GITHUB_ACTION_ROLE_ARN_PROD }}
          session_name: GitHubActions-ProdDeploy-${{ github.run_id }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Build and Push Image
        uses: ./.github/actions/build-push-image
        with:
          ecr_repository: ${{ vars.AWS_ECR_REPOSITORY_PROD }}
          image_tag: ${{ needs.build-and-deploy.outputs.image_tag }}

      - name: Deploy CDK Infrastructure
        uses: ./.github/actions/deploy-cdk
        with:
          environment: prod
          image_tag: ${{ needs.build-and-deploy.outputs.image_tag }}
